<!DOCTYPE html>
<html>
  <head>
    <title>iRich 愛記帳</title>
    <link rel='stylesheet' href='/stylesheets/style.css' />
    <link rel="stylesheet" type="text/css" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  </head>
  <body>
    <nav class="navbar navbar-inverse navbar-fixed-top">
		<div class="container">
			<div class="navbar-header">
				<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				</button>
	          	<a class="navbar-brand" href="/">iRich 愛記帳</a>       
	        </div>
	        <div id="navbar" class="navbar-collapse collapse">
	        	<div class="navbar-right navbar-form">
					<a href="/accounts/create"><button class="btn btn-success">新增消費</button></a>        		
	        	</div>
			</div><!--/.navbar-collapse -->   
    	</div>
    </nav>

    <div class="main-container">
		<div class="container-fluid">
			<div class="col-md-12">
				<div>
					<h3>統計資料</h3>
					<div id="data-chart-info"></div>
					<canvas id="data-chart" width="1000" height="200"></canvas>
				</div>
				<div>
					<h3>詳細支出</h3>
					<table class="table table-hover" id="data-table"></table>			
				</div>
			</div>
		</div>

	    <div class="container">
			<table class="table table-hover">
				<tr>
					<th>標題</th>
					<th>分類</th>
					<th>花費</th>
					<th>操作</th>
				</tr>
				<% for(var i = 0; i < accounts.length; i++) { %>
					<div></div>
					<tr>
						<td><a href="/accounts/<%= accounts[i].id %>"><%= accounts[i].title %></a></td>
						<td><%= accounts[i].type %></td>
						<td><%= accounts[i].cost %></td>
						<td><a href="/accounts/<%= accounts[i].id %>/update"><button class="btn btn-warning">更新</button></a></td>
						<td>
							<form action="/accounts/<%= accounts[i].id %>/delete" method="POST">
								<button class="btn btn-danger">刪除</button>
							</form>
						</td>
					</tr>		
				<% } %>
			</table>
	    </div>

    </div>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.1.4/Chart.bundle.min.js"></script>
	<script type="text/javascript">
		var loadChart = function(rawData) {
		    let eat = 0;
		    let cloth = 0;
		    let home = 0;
		    let traffic = 0;
		    let play = 0;
		    const ctxRef = document.querySelector('#data-chart');
		    const infoRef = document.querySelector('#data-chart-info');
		    rawData.forEach(function(value, index) {
		        const type = value.type;
		        const cost = value.cost;
		        switch(type) {
		          case 'eat':
		            eat += parseInt(cost);
		            break;
		          case 'cloth':
		            cloth += parseInt(cost);
		            break;
		          case 'home':
		            home += parseInt(cost);
		            break;          
		          case 'traffic':
		            traffic += parseInt(cost);
		            break; 
		          case 'play':
		            play += parseInt(cost);
		            break;
		        }
		      
		    });
		    const data = {
		        labels: [
		            '餐費',
		            '服飾',
		            '住',
		            '行',
		            '育樂'
		        ],
		        datasets: [{
		            data: [eat, cloth, home, traffic, play],
		            backgroundColor: [
		                'rgba(255, 99, 132, 0.5)',
		                'rgba(54, 162, 235, 0.5)',
		                'rgba(255, 206, 86, 0.5)',
		                'rgba(75, 192, 192, 0.5)',
		                'rgba(153, 102, 255, 0.5)',
		            ],
		            borderColor: [
		                'rgba(255, 99, 132, 1)',
		                'rgba(54, 162, 235, 1)',
		                'rgba(255, 206, 86, 1)',
		                'rgba(75, 192, 192, 1)',
		                'rgba(153, 102, 255, 1)',
		            ],
		        }]
		    };
		    const myPieChart = new Chart(ctxRef, {
		        type: 'pie',
		        data: data,
		    });      
		}  		
		var xhr = new XMLHttpRequest();
		xhr.open('GET', '/api/accounts');
		xhr.onreadystatechange = function() {
			if(xhr.readyState === 4) {
				console.log(xhr.responseText);

				loadChart(JSON.parse(xhr.responseText));
				//return xhr;
			}
		}
		xhr.send();
  	</script>
  </body>
</html>
